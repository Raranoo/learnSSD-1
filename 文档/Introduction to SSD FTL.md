# Introduction to SSD FTL （简单介绍 FTL 的功能，包括地址映射，垃圾回收，损耗均衡）

@(示例笔记本)[马克飞象|帮助|Markdown]

## FTL简介
 > 闪存转换层（flash translation layer, FTL）,完成主机（或者用户，Host）**逻辑地址空间**到闪存（Flash）**物理空间地址**的翻译（Translation），或者说映射（Mapping）。

SSD每把一笔用户逻辑数据写入闪存地址空间，便记录下该逻辑地址到物理地址的映射关系。当主机想读取该数据时，SSD便会根据这个映射，从闪存读取这笔数据后返回给用户。**FTL可以说是SSD固件的核心组成。**

## FTL的功能

### 映射管理

根据 **映射粒度** 的不同，FTL映射分为如下几种：
- **块映射** 
- **页映射**  
- **混合映射**  

三种映射的对比：

|  | 块映射 | 页映射 | 混合映射|
|-----|--------|------|-------|
|映射单元 | 物理块 | 物理页 | 块页结合|
|顺序写性能|好|好|好|
|顺序读性能|好|好|好|
|随机写性能|很差|好|差|
|随机读性能|好|好|好|
|映射表大小|小|大|一般|

>**注意：** 现在的SSD基本都是采用页映射方式。

#### 映射原理

SSD内部维护一张 **映射表** 。每次用户写入逻辑页时，就会产生一个新的映射关系，会加入或者更改映射表。当读取逻辑页时，SSD先查询映射表中的该逻辑页对应的物理页，然后再访问。

大部分SSD的映射表放在板载DRAM当中，少数SSD采用二级映射，一级映射表常驻SRAM，二级映射表大部分在闪存中。
还有一种是HMB（Host Memory Buffer）把映射表放在主机内存中。HMB性能在DRAM和闪存中间。

#### 映射表的刷新

一般在一下几种情况下出发映射表写入闪存：
- **新产生的映射关系累积到一定的阈值**
- **用户写入的数据量到达一定的阈值**
- **闪存写完闪存块的数量到达一定的阈值**
- **其他**

写入策略：
- **全部更新** 
- **部分更新更新**